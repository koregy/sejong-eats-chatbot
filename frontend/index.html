<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ë ¤ëŒ€í•™êµ ì„¸ì¢…ìº í¼ìŠ¤ ë§›ì§‘ ì¶”ì²œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .chat-animation {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="max-w-4xl mx-auto p-4 h-screen flex flex-col">
        <div class="bg-white rounded-t-2xl shadow-lg p-6 border-b border-gray-100">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    <span class="text-white text-xl">ğŸ½ï¸</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">ì¿ ì•™ - ê³ ë ¤ëŒ€í•™êµ ë§›ì§‘ ì¶”ì²œ</h1>
                    <p class="text-gray-500 text-sm">ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì¿ ì•™ì´ì—ìš”. ê³ ëŒ€ ì£¼ë³€ ë§›ì§‘ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”!</p>
                </div>
            </div>
        </div>

        <div id="chatContainer" class="flex-1 bg-white p-6 overflow-y-auto space-y-4">
        </div>

        <div class="bg-white rounded-b-2xl shadow-lg p-6 border-t border-gray-100">
            <div class="flex space-x-3">
                <input
                    type="text"
                    id="messageInput"
                    placeholder="ì˜ˆ: ì¿ ì•™ì•„ í•œì‹ ë§›ì§‘ ì¶”ì²œí•´ì¤˜"
                    class="flex-1 border border-gray-300 rounded-full px-6 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onkeypress="handleKeyPress(event)"
                >
                <button
                    onclick="sendMessage()"
                    class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-full hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-medium shadow-lg hover:shadow-xl transform hover:scale-105"
                >
                    ì „ì†¡
                </button>
            </div>
        </div>
    </div>

    <div id="restaurantPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white rounded-t-2xl border-b border-gray-200 p-6 flex items-center justify-between">
                <h2 id="popupTitle" class="text-2xl font-bold text-gray-800"></h2>
                <button onclick="closeRestaurantPopup()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>
           
            <div class="p-6">
                <div id="restaurantInfo" class="mb-6">
                </div>
               
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ’¬ ê³ ê° ë¦¬ë·°</h3>
                    <div id="reviewsList" class="space-y-3 mb-4">
                    </div>
                </div>
               
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">âœï¸ ë¦¬ë·° ì‘ì„±í•˜ê¸°</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë³„ì </label>
                            <div class="flex space-x-1">
                                <button type="button" onclick="setRating(1)" class="rating-btn text-3xl text-gray-300 hover:text-yellow-400 transition-all duration-200 hover:scale-110" data-rating="1">â­</button>
                                <button type="button" onclick="setRating(2)" class="rating-btn text-3xl text-gray-300 hover:text-yellow-400 transition-all duration-200 hover:scale-110" data-rating="2">â­</button>
                                <button type="button" onclick="setRating(3)" class="rating-btn text-3xl text-gray-300 hover:text-yellow-400 transition-all duration-200 hover:scale-110" data-rating="3">â­</button>
                                <button type="button" onclick="setRating(4)" class="rating-btn text-3xl text-gray-300 hover:text-yellow-400 transition-all duration-200 hover:scale-110" data-rating="4">â­</button>
                                <button type="button" onclick="setRating(5)" class="rating-btn text-3xl text-gray-300 hover:text-yellow-400 transition-all duration-200 hover:scale-110" data-rating="5">â­</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë¦¬ë·° ë‚´ìš©</label>
                            <textarea id="reviewContent" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ë§›ìˆê²Œ ë“œì‹  ìŒì‹ì— ëŒ€í•œ ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!"></textarea>
                        </div>
                        <button onclick="submitReview()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-medium">
                            ë¦¬ë·° ë“±ë¡í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Lambda URL ìƒìˆ˜ ì •ì˜
        const MY_API_URL = "https://oubs5fjubrwkxkva6rdbwsndgy0rkeaq.lambda-url.ap-northeast-2.on.aws/";

        const LAMBDA_URLS = {
            RESTAURANTS: MY_API_URL,
            DETAILS: MY_API_URL
        };

        // ì „ì—­ ë³€ìˆ˜
        let allRestaurants = [];
        let categories = [];
        let currentRestaurant = null;
        let selectedRating = 0;

        // ì´ˆê¸°í™”
        window.onload = function() {
            loadRestaurants();
        };

        async function loadRestaurants() {
            allRestaurants = [];
            categories = ['ì „ì²´']; 
            addBotResponse('ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì¿ ì•™ì´ì—ìš”! ê³ ë ¤ëŒ€ ì„¸ì¢…ìº í¼ìŠ¤ ì£¼ë³€ ë§›ì§‘ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”! ë¬´ì—‡ì„ ì°¾ìœ¼ì‹œë‚˜ìš”? ğŸ´âœ¨<br><br><small>ì˜ˆ: "í•œì‹", "ì¹˜í‚¨", "ì¹´í˜" ë“±ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”!</small>');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
           
            if (!message) return;

            addUserMessage(message);
            input.value = '';

            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                processMessage(message);
            }, 1500);
        }

        function addUserMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 justify-end chat-animation';
            messageDiv.innerHTML = `
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-2xl rounded-tr-md p-4 max-w-md">
                    <p>${message}</p>
                </div>
                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-gray-600 text-sm">ğŸ‘¤</span>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex items-start space-x-3';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm">ğŸ¤–</span>
                </div>
                <div class="bg-gray-100 rounded-2xl rounded-tl-md p-4 max-w-md">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function processMessage(message) {
            const lowerMessage = message.toLowerCase();
            let responseMessage = '';

            const kuangNames = ['ì¿ ì•™ì•„', 'ì¿ ì•™ì´', 'ì¿ ì•™'];
            let cleanedMessage = lowerMessage;
            let isCallingKuang = false;
            kuangNames.forEach(name => {
                if (cleanedMessage.includes(name)) {
                    cleanedMessage = cleanedMessage.replace(name, '').trim();
                    isCallingKuang = true;
                }
            });

            if (isCallingKuang && (cleanedMessage === '' || cleanedMessage.length < 2)) {
                const greetings = [
                    'ë„¤! ë¶€ë¥´ì…¨ì–´ìš”? ì–´ë–¤ ë§›ì§‘ì„ ì°¾ê³  ê³„ì‹ ê°€ìš”? ğŸ˜Š',
                    'ë„¤! ì¿ ì•™ì´ ì—¬ê¸° ìˆì–´ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ½ï¸',
                    'ë„¤! ë§›ì§‘ ì¶”ì²œì´ í•„ìš”í•˜ì‹œêµ°ìš”! ì–´ë–¤ ìŒì‹ì´ ë“œì‹œê³  ì‹¶ìœ¼ì„¸ìš”? ğŸ¤—'
                ];
                const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
                addBotResponse(randomGreeting);
                return;
            }

            // ë¦¬ë·° ì‘ì„± ì•ˆë‚´
            if (cleanedMessage.includes('ë¦¬ë·°') && (cleanedMessage.includes('ì‘ì„±') || cleanedMessage.includes('ì“°ê¸°') || cleanedMessage.includes('ë“±ë¡'))) {
                const greeting = isCallingKuang ? 'ë„¤! ' : '';
                addBotResponse(greeting + 'ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ê³  ì‹¶ìœ¼ì‹œêµ°ìš”! ë‹¤ìŒê³¼ ê°™ì´ ë©”ì‹œì§€ë¡œ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:<br><br><strong>í˜•ì‹:</strong> "ë§›ì§‘ì´ë¦„ ë¦¬ë·° ë³„ì  ë‚´ìš©"<br><br><strong>ì˜ˆì‹œ:</strong><br>â€¢ "ë”ë•ì†¥ëšœê»‘ì‚¼ê²¹ì‚´ ë¦¬ë·° 5ì  ì‚¼ê²¹ì‚´ì´ ì •ë§ ë§›ìˆì–´ìš”!"<br>â€¢ "ëŠ¥ì†Œë¹„ë¹”êµ­ìˆ˜ ë¦¬ë·° 4ì  ì—¬ë¦„ì— ë¨¹ê¸° ì¢‹ì•„ìš”!"<br><br>ì´ë ‡ê²Œ ì‘ì„±í•´ì£¼ì‹œë©´ ë¦¬ë·°ë¥¼ ë“±ë¡í•´ë“œë¦´ê²Œìš”! âœï¸');
                return;
            }

            // ë¦¬ë·° ë“±ë¡ ì²˜ë¦¬
            const reviewPattern = /(.+?)\s+ë¦¬ë·°\s+(\d)ì \s+(.+)/;
            const reviewMatch = message.match(reviewPattern);
            if (reviewMatch) {
                const [, restaurantName, rating, content] = reviewMatch;
                const ratingNum = parseInt(rating);
               
                if (ratingNum >= 1 && ratingNum <= 5) {
                    const restaurant = allRestaurants.find(r => r.name.includes(restaurantName.trim()) || restaurantName.trim().includes(r.name));
                   
                    if (restaurant) {
                        const today = new Date().toISOString().split('T')[0];
                        const newReview = {
                            author: 'ì‚¬ìš©ì',
                            rating: ratingNum,
                            content: content.trim(),
                            date: today
                        };
                        restaurant.reviews.push(newReview);
                       
                        const totalRating = restaurant.reviews.reduce((sum, review) => sum + review.rating, 0);
                        restaurant.rating = (totalRating / restaurant.reviews.length).toFixed(1);
                       
                        addBotResponse(`${restaurant.name}ì— ëŒ€í•œ ${ratingNum}ì  ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒŸ<br><br><strong>ë¦¬ë·° ë‚´ìš©:</strong> "${content.trim()}"<br><br>ì†Œì¤‘í•œ í›„ê¸° ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜Š`);
                    } else {
                        addBotResponse(`"${restaurantName.trim()}" ë§›ì§‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ë§›ì§‘ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”! ğŸ”`);
                    }
                } else {
                    addBotResponse('ë³„ì ì€ 1ì ë¶€í„° 5ì ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì‘ì„±í•´ì£¼ì„¸ìš”! â­');
                }
                return;
            }

            // Lambdaë¥¼ í†µí•œ ë§›ì§‘ ê²€ìƒ‰
            try {
                const matchedRestaurants = await searchRestaurantsWithLambda(cleanedMessage);
                if (matchedRestaurants && matchedRestaurants.length > 0) {
                    const greeting = isCallingKuang ? 'ë„¤! ' : '';
                    responseMessage = greeting + `"${cleanedMessage}"ê³¼(ì™€) ê´€ë ¨ëœ ë§›ì§‘ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”! ğŸ½ï¸âœ¨`;
                   
                    addBotResponse(responseMessage);
                    setTimeout(() => {
                        matchedRestaurants.slice(0, 3).forEach((restaurant, index) => {
                            setTimeout(() => {
                                addRestaurantRecommendation(restaurant);
                            }, (index + 1) * 800);
                        });
                    }, 500);
                } else {
                    const greeting = isCallingKuang ? 'ë„¤! ' : '';
                    addBotResponse(greeting + 'ì£„ì†¡í•´ìš”, ì°¾ìœ¼ì‹œëŠ” ë§›ì§‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ ë³´ì‹œê² ì–´ìš”? ğŸ˜Š');
                }
            } catch (error) {
                console.error('Search error:', error);
                const greeting = isCallingKuang ? 'ë„¤! ' : '';
                addBotResponse(greeting + 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸ™');
            }
        }

        // Lambdaë¥¼ í†µí•œ ë§›ì§‘ ê²€ìƒ‰ í•¨ìˆ˜
        async function searchRestaurantsWithLambda(message) {
            try {
                const response = await fetch(LAMBDA_URLS.RESTAURANTS, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Lambda search response:', data);

                // Lambda ì‘ë‹µ êµ¬ì¡° íŒŒì‹±
                let result = null;
                if (data.body) {
                    result = typeof data.body === 'string' ? JSON.parse(data.body) : data.body;
                } else {
                    result = data;
                }

                // ë§›ì§‘ ëª©ë¡ì´ ìˆëŠ” ê²½ìš°
                if (result.restaurants && Array.isArray(result.restaurants)) {
                    const restaurants = result.restaurants.map(restaurant => ({
                        id: restaurant.id,
                        name: restaurant.place_name,
                        info: `${restaurant.main_category} | ${restaurant.road_address_name}`,
                        rating: restaurant.scraped_rating || '0.0',
                        image: getCategoryEmoji(restaurant.main_category),
                        phone: restaurant.phone,
                        address: restaurant.road_address_name,
                        url: restaurant.place_url,
                        operating_hours: restaurant.operating_hours_summary || '',
                        reviews: []
                    }));
                    
                    allRestaurants.push(...restaurants);
                    return restaurants;
                }
                // Bedrock ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš°
                else if (result.message) {
                    addBotResponse(result.message);
                    return [];
                }

                return [];

            } catch (error) {
                console.error('Lambda search failed:', error);
                throw error;
            }
        }

        // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€ ë°˜í™˜
        function getCategoryEmoji(category) {
            const emojiMap = {
                'í•œì‹': 'ğŸš',
                'ì¤‘ì‹': 'ğŸ¥¡', 
                'ì¼ì‹': 'ğŸ£',
                'ì–‘ì‹': 'ğŸ',
                'ì¹´í˜': 'â˜•',
                'ì¹˜í‚¨': 'ğŸ—',
                'ë¶„ì‹': 'ğŸ¥Ÿ',
                'ê³ ê¸°': 'ğŸ¥©',
                'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ': 'ğŸ”'
            };
            return emojiMap[category] || 'ğŸ½ï¸';
        }

        function addBotResponse(message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 chat-animation';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm">ğŸ¤–</span>
                </div>
                <div class="bg-gray-100 rounded-2xl rounded-tl-md p-4 max-w-md">
                    <p class="text-gray-800">${message}</p>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addRestaurantRecommendation(restaurant) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-3 chat-animation';
            const currentRating = calculateCurrentRating(restaurant);
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm">ğŸ¤–</span>
                </div>
                <div class="bg-white border border-gray-200 rounded-2xl rounded-tl-md p-5 max-w-md shadow-sm">
                    <div class="flex items-start space-x-4 mb-3">
                        <div class="text-4xl">${restaurant.image || 'ğŸ½ï¸'}</div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg text-gray-800">${restaurant.name}</h3>
                                <div class="flex items-center space-x-1">
                                    <span class="text-yellow-400">â­</span>
                                    <span class="text-sm font-medium text-gray-600">${currentRating}</span>
                                </div>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">${restaurant.info}</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                         <div class="mt-3 pt-3 border-t border-gray-100">
                            <button onclick="showRestaurantPopup('${restaurant.name.replace(/'/g, "\\'")}', '${restaurant.id || ''}')" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-2 px-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 text-sm font-medium">
                                ìƒì„¸ì •ë³´ ë³´ê¸° & ë¦¬ë·° ì‘ì„±
                            </button>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function getRestaurantByName(name) {
            return allRestaurants.find(r => r.name === name);
        }

        function calculateCurrentRating(restaurant) {
            if (restaurant.reviews && restaurant.reviews.length > 0) {
                const totalRating = restaurant.reviews.reduce((sum, review) => sum + review.rating, 0);
                return (totalRating / restaurant.reviews.length).toFixed(1);
            }
            return restaurant.rating || '0.0';
        }

        // ë ˆìŠ¤í† ë‘ ìƒì„¸ì •ë³´ íŒì—…
        async function showRestaurantPopup(restaurantName, restaurantId = null) {
            currentRestaurant = getRestaurantByName(restaurantName);
            if (!currentRestaurant) return;

            const popup = document.getElementById('restaurantPopup');
            const title = document.getElementById('popupTitle');
            const info = document.getElementById('restaurantInfo');

            title.textContent = currentRestaurant.name;

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            info.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="loading-spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mr-3"></div>
                    <span class="text-gray-600">ìƒì„¸ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                </div>
            `;

            try {
                // Lambda ìƒì„¸ì •ë³´ API í˜¸ì¶œ
                const detailResponse = await fetch(LAMBDA_URLS.DETAILS, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        restaurant_id: currentRestaurant.id
                    })
                });

                if (detailResponse.ok) {
                    const response = await detailResponse.json();
                    
                    let detailData = {};
                    if (response.body) {
                        detailData = typeof response.body === 'string' ? JSON.parse(response.body) : response.body;
                    } else {
                        detailData = response;
                    }

                    const operatingHours = detailData.operating_hours || [];
                    const reviews = detailData.reviews || [];

                    // ì˜ì—…ì‹œê°„ ì •ë³´ ì²˜ë¦¬
                    let hoursInfo = '';
                    if (operatingHours.length > 0) {
                        const today = new Date().getDay();
                        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                        const todayKorean = dayNames[today];
                        
                        const todayHours = operatingHours.find(h => h.day_of_week === todayKorean);
                        if (todayHours && todayHours.status === 'OPEN') {
                            hoursInfo = `ì˜¤ëŠ˜ ${todayHours.open_time} - ${todayHours.close_time}`;
                        } else {
                            hoursInfo = 'ì˜¤ëŠ˜ íœ´ë¬´ ë˜ëŠ” ì •ë³´ ì—†ìŒ';
                        }
                    } else {
                        hoursInfo = 'ì˜ì—…ì‹œê°„ ì •ë³´ ì—†ìŒ';
                    }

                    // ë¦¬ë·° ì •ë³´ë¥¼ currentRestaurantì— ì €ì¥
                    currentRestaurant.reviews = reviews.map(review => ({
                        author: 'ê³ ê°',
                        rating: review.rating,
                        content: review.comment,
                        date: review.created_at
                    }));

                    const currentRating = currentRestaurant.reviews.length > 0 ? 
                        (currentRestaurant.reviews.reduce((sum, r) => sum + r.rating, 0) / currentRestaurant.reviews.length).toFixed(1) :
                        currentRestaurant.rating;

                    // URL ë²„íŠ¼ ìƒì„± ë¡œì§
                    let urlButtonHtml = '';
                    if (currentRestaurant.url) {
                        urlButtonHtml = `
                            <div class="mt-4 pt-3 border-t border-dashed border-gray-200">
                                <a href="${currentRestaurant.url}" target="_blank" class="flex items-center justify-center w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 shadow-md transform hover:scale-[1.02]">
                                    <span class="mr-2">ğŸ—ºï¸</span> ì¹´ì¹´ì˜¤ë§µì—ì„œ ìœ„ì¹˜ ë³´ê¸°
                                </a>
                            </div>
                        `;
                    }

                    // ìƒì„¸ì •ë³´ í‘œì‹œ
                    info.innerHTML = `
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="text-6xl">${currentRestaurant.image || 'ğŸ½ï¸'}</div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-yellow-400 text-xl">â­</span>
                                    <span class="text-lg font-semibold">${currentRating}</span>
                                    <span class="text-gray-500">(${currentRestaurant.reviews.length}ê°œ ë¦¬ë·°)</span>
                                </div>
                                <p class="text-gray-600 mb-3">${currentRestaurant.info}</p>
                                <div class="space-y-2 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-blue-500">ğŸ“</span>
                                        <span>${currentRestaurant.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-green-500">ğŸ“</span>
                                        <span>${currentRestaurant.phone || 'ì „í™”ë²ˆí˜¸ ì •ë³´ ì—†ìŒ'}</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-orange-500">ğŸ•’</span>
                                        <span>${hoursInfo}</span>
                                    </div>
                                </div>
                                ${urlButtonHtml} </div>
                        </div>
                    `;

                } else {
                    throw new Error(`ìƒì„¸ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ${detailResponse.status}`);
                }

            } catch (error) {
                console.error('Failed to load restaurant details:', error);
                
                // ì—ëŸ¬ ë°œìƒì‹œ ê¸°ë³¸ ì •ë³´ + URL ë²„íŠ¼ í‘œì‹œ
                const currentRating = calculateCurrentRating(currentRestaurant);
                
                // ì—ëŸ¬ ìƒí™©ì—ì„œë„ URL ë²„íŠ¼ í‘œì‹œ
                let urlButtonHtml = '';
                if (currentRestaurant.url) {
                    urlButtonHtml = `
                        <div class="mt-4 pt-3 border-t border-dashed border-gray-200">
                            <a href="${currentRestaurant.url}" target="_blank" class="flex items-center justify-center w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded-xl transition-all duration-200 shadow-md">
                                <span class="mr-2">ğŸ—ºï¸</span> ì¹´ì¹´ì˜¤ë§µì—ì„œ ìœ„ì¹˜ ë³´ê¸°
                            </a>
                        </div>
                    `;
                }
                
                info.innerHTML = `
                    <div class="flex items-start space-x-4 mb-4">
                        <div class="text-6xl">${currentRestaurant.image || 'ğŸ½ï¸'}</div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-yellow-400 text-xl">â­</span>
                                <span class="text-lg font-semibold">${currentRating}</span>
                                <span class="text-gray-500">(${currentRestaurant.reviews.length}ê°œ ë¦¬ë·°)</span>
                            </div>
                            <p class="text-gray-600 mb-3">${currentRestaurant.info}</p>
                            <div class="text-sm text-yellow-600 bg-yellow-50 p-3 rounded-lg">
                                âš ï¸ ìƒì„¸ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì •ë³´ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                            </div>
                            ${urlButtonHtml}
                        </div>
                    </div>
                `;
            }

            updateReviewsList();
            resetReviewForm();
            popup.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // íŒì—… ë‹«ê¸°
        function closeRestaurantPopup() {
            const popup = document.getElementById('restaurantPopup');
            popup.classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentRestaurant = null;
            selectedRating = 0;
        }

        // ë³„ì  ì„¤ì •
        function setRating(rating) {
            selectedRating = rating;
            updateRatingDisplay();
        }

        // ë³„ì  í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateRatingDisplay() {
            const ratingBtns = document.querySelectorAll('.rating-btn');
            ratingBtns.forEach((btn) => {
                const btnRating = parseInt(btn.getAttribute('data-rating'));
                if (btnRating <= selectedRating) {
                    btn.classList.remove('text-gray-300');
                    btn.classList.add('text-yellow-400');
                    btn.style.transform = 'scale(1.1)';
                } else {
                    btn.classList.remove('text-yellow-400');
                    btn.classList.add('text-gray-300');
                    btn.style.transform = 'scale(1)';
                }
            });
        }
       
        // ë¦¬ë·° ì œì¶œ
        async function submitReview() {
            if (!currentRestaurant) return;
            const content = document.getElementById('reviewContent').value.trim();
           
            if (selectedRating === 0) {
                alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
           
            if (!content) {
                alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            try {
                const today = new Date().toISOString().split('T')[0];
                const newReview = {
                    author: 'ì‚¬ìš©ì',
                    rating: selectedRating,
                    content: content,
                    date: today
                };

                // ë¡œì»¬ì—ì„œ ë¦¬ë·° ì €ì¥
                currentRestaurant.reviews.push(newReview);
               
                const totalRating = currentRestaurant.reviews.reduce((sum, review) => sum + review.rating, 0);
                const newRating = (totalRating / currentRestaurant.reviews.length).toFixed(1);
                currentRestaurant.rating = newRating;
               
                updatePopupRatingInfo(newRating);
                updateReviewsList();
                
                addBotResponse(`${currentRestaurant.name}ì— ${selectedRating}ì  ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¡œì»¬ ì €ì¥) ğŸŒŸ<br><br><strong>ìƒˆë¡œìš´ í‰ì :</strong> ${newRating}ì  (${currentRestaurant.reviews.length}ê°œ ë¦¬ë·°)<br><strong>ë¦¬ë·° ë‚´ìš©:</strong> "${content}"<br><br>ì†Œì¤‘í•œ í›„ê¸° ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜Š`);
                
                resetReviewForm();
                setTimeout(() => {
                    closeRestaurantPopup();
                }, 1000);

            } catch (error) {
                console.error('Review submission error:', error);
                alert('ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // íŒì—… í‰ì  ì •ë³´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        function updatePopupRatingInfo(newRating) {
            const info = document.getElementById('restaurantInfo');
            const ratingElement = info.querySelector('.text-lg.font-semibold');
            const reviewCountElement = info.querySelector('.text-gray-500');
           
            if (ratingElement) {
                ratingElement.textContent = newRating;
                ratingElement.style.transform = 'scale(1.2)';
                ratingElement.style.color = '#f59e0b';
                setTimeout(() => {
                    ratingElement.style.transform = 'scale(1)';
                    ratingElement.style.color = '';
                }, 300);
            }
           
            if (reviewCountElement) {
                reviewCountElement.textContent = `(${currentRestaurant.reviews.length}ê°œ ë¦¬ë·°)`;
                reviewCountElement.style.transform = 'scale(1.1)';
                reviewCountElement.style.color = '#3b82f6';
                setTimeout(() => {
                    reviewCountElement.style.transform = 'scale(1)';
                    reviewCountElement.style.color = '';
                }, 300);
            }
        }

        // ë¦¬ë·° ëª©ë¡ ì—…ë°ì´íŠ¸ (ìµœì‹  3ê°œë§Œ)
        function updateReviewsList() {
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = '';
           
            if (currentRestaurant.reviews.length === 0) {
                reviewsList.innerHTML = '<p class="text-gray-500 text-center py-4">ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
           
            const recentReviews = currentRestaurant.reviews.slice().reverse().slice(0, 3);
            recentReviews.forEach(review => {
                const reviewItem = document.createElement('div');
                reviewItem.className = 'p-4 bg-gray-50 rounded-lg';
                reviewItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold text-gray-800">${review.author}</span>
                            <div class="flex">
                                ${'â­'.repeat(review.rating)}
                            </div>
                        </div>
                        <span class="text-sm text-gray-500">${review.date}</span>
                    </div>
                    <p class="text-gray-700">${review.content}</p>
                `;
                reviewsList.appendChild(reviewItem);
            });
            if (currentRestaurant.reviews.length > 3) {
                const moreReviewsInfo = document.createElement('div');
                moreReviewsInfo.className = 'text-center text-sm text-gray-500 mt-2';
                moreReviewsInfo.innerHTML = `ìµœì‹  3ê°œ ë¦¬ë·°ë§Œ í‘œì‹œë©ë‹ˆë‹¤. (ì „ì²´ ${currentRestaurant.reviews.length}ê°œ ë¦¬ë·°)`;
                reviewsList.appendChild(moreReviewsInfo);
            }
        }

        // ë¦¬ë·° í¼ ì´ˆê¸°í™”
        function resetReviewForm() {
            selectedRating = 0;
            document.getElementById('reviewContent').value = '';
            const ratingBtns = document.querySelectorAll('.rating-btn');
            ratingBtns.forEach(btn => {
                btn.classList.remove('text-yellow-400');
                btn.classList.add('text-gray-300');
                btn.style.transform = 'scale(1)';
            });
        }
    </script>
</body>
</html>